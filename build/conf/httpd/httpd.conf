# unbscholar.dspace.lib.unb.ca
LoadModule proxy_module modules/mod_proxy.so
LoadModule proxy_ajp_module modules/mod_proxy_ajp.so
LoadModule mod_shib /usr/lib/apache2/modules/mod_shib.so
Include /etc/apache2/conf-available/shib.conf

ServerName unbscholar.dspace.lib.unb.ca
UseCanonicalName On
ServerAdmin webmaster@unbscholar.dspace.lib.unb.ca

LogLevel warn
ErrorLog /proc/self/fd/2
CustomLog /proc/self/fd/2 combined

<IfModule mod_shib>
   # Shibboleth recommends turning on UseCanonicalName
   # See "Prepping Apache" in https://wiki.shibboleth.net/confluence/display/SHIB2/NativeSPApacheConfig
   UseCanonicalName On

   # Most DSpace instances will want to use Shibboleth "Lazy Session", which ensures that users
   # can access DSpace without first authenticating via Shibboleth.
   # This section turns on Shibboleth "Lazy Session". Also ensures that once they have authenticated
   # (by accessing /Shibboleth.sso/Login path), then their Shib session is kept alive
   <Location />
      AuthType shibboleth
      ShibRequireSession Off
      require shibboleth
      # If your "shibboleth2.xml" file specifies an <ApplicationOverride> setting for your
      # DSpace Service Provider, then you may need to tell Apache which "id" to redirect Shib requests to.
      # Just uncomment this and change the value "my-dspace-id" to the associated @id attribute value.
      #ShibRequestSetting applicationId my-dspace-id
   </Location>

   # If a user attempts to access the DSpace shibboleth login page, force them to authenticate via Shib
   <Location "/server/api/authn/shibboleth">
      Order deny,allow
      Allow from all
      AuthType shibboleth
      ShibRequireSession On
      # Please note that setting ShibUseHeaders to "On" is a potential security risk.
      # You may wish to set it to "Off". See the mod_shib docs for details about this setting:
      # https://wiki.shibboleth.net/confluence/display/SHIB2/NativeSPApacheConfig#NativeSPApacheConfig-AuthConfigOptions
      # Here's a good guide to configuring Apache + Tomcat when this setting is "Off":
      # https://www.switch.ch/de/aai/support/serviceproviders/sp-access-rules.html#javaapplications
      ShibUseHeaders On
      require shibboleth
   </Location>
   <Location "/server/api/authn/login">
      Order deny,allow
      Allow from all
      AuthType shibboleth
      # For DSpace, this is required to be off otherwise the available auth methods will be not visible
      ShibRequireSession Off
      # Please note that setting ShibUseHeaders to "On" is a potential security risk.
      # You may wish to set it to "Off". See the mod_shib docs for details about this setting:
      # https://wiki.shibboleth.net/confluence/display/SHIB2/NativeSPApacheConfig#NativeSPApacheConfig-AuthConfigOptions
      # Here's a good guide to configuring Apache + Tomcat when this setting is "Off":
      # https://www.switch.ch/de/aai/support/serviceproviders/sp-access-rules.html#javaapplications
      ShibUseHeaders On
   </Location>

   # Ensure /Shibboleth.sso path (in Apache) can be accessed
   # By default it may be inaccessible if your Apache security is tight.
   <Location "/Shibboleth.sso">
      Order deny,allow
      Allow from all
      # Also ensure Shibboleth/mod_shib responds to this path
      SetHandler shib
   </Location>

   # Finally, you may need to ensure requests to /Shibboleth.sso are NOT redirected
   # to Tomcat (as they need to be handled by mod_shib instead).
   # NOTE: THIS SETTING IS LIKELY ONLY NEEDED IF YOU ARE USING mod_proxy TO REDIRECT
   # ALL REQUESTS TO TOMCAT (e.g. ProxyPass / ajp://localhost:8009/)
   ProxyPass /Shibboleth.sso !
</IfModule>

## Proxy / Forwarding Settings ##
<Proxy *>
  AddDefaultCharset Off
  Order allow,deny
  Allow from all
</Proxy>

# Proxy all requests to /server to Tomcat via AJP
# NOTE: Host (dspace) matches Docker container name of Tomcat container
ProxyPass /server ajp://dspace:8009/server
ProxyPassReverse /server ajp://dspace:8009/server
